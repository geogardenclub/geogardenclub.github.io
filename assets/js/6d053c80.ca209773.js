"use strict";(self.webpackChunkgeogardenclub_github_io=self.webpackChunkgeogardenclub_github_io||[]).push([[5138],{8062:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>r,contentTitle:()=>s,default:()=>h,frontMatter:()=>i,metadata:()=>d,toc:()=>l});var n=o(4848),a=o(8453);const i={hide_table_of_contents:!1,toc_max_heading_level:2},s="Cloud Storage Data Model",d={id:"develop/data-model/cloud-storage-data-model",title:"Cloud Storage Data Model",description:"This page explains the cloud storage data model (i.e. the way our Cloud Storage bucket is organized).",source:"@site/docs/develop/data-model/cloud-storage-data-model.md",sourceDirName:"develop/data-model",slug:"/develop/data-model/cloud-storage-data-model",permalink:"/docs/develop/data-model/cloud-storage-data-model",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{hide_table_of_contents:!1,toc_max_heading_level:2},sidebar:"developSidebar",previous:{title:"Document Data Model",permalink:"/docs/develop/data-model/document-data-model"},next:{title:"Database management",permalink:"/docs/develop/database-management"}},r={},l=[{value:"Overview",id:"overview",level:2},{value:"<code>/images</code>",id:"images",level:2},{value:"<code>/backups</code>",id:"backups",level:2}];function c(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.header,{children:(0,n.jsx)(t.h1,{id:"cloud-storage-data-model",children:"Cloud Storage Data Model"})}),"\n",(0,n.jsx)(t.p,{children:"This page explains the cloud storage data model (i.e. the way our Cloud Storage bucket is organized)."}),"\n",(0,n.jsxs)(t.p,{children:["There is also a ",(0,n.jsx)(t.a,{href:"/docs/develop/data-model/document-data-model",children:"Document Data Model"}),"."]}),"\n",(0,n.jsx)(t.h2,{id:"overview",children:"Overview"}),"\n",(0,n.jsx)(t.p,{children:"We currently use Google Cloud Storage for two purposes:"}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"To store the image files associated with various entities."}),"\n",(0,n.jsx)(t.li,{children:"To store a snapshot copy of the Firebase collections and documents for offsite backup."}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:'Our Cloud Storage consists of a single "bucket", which is organized into a set of "folders" (and subfolders).  Note that the folder concept is implemented through a naming convention for the objects in a bucket: if the path name contains "/" characters, these are interpreted as demarcating a hierarchy of folders with a file at the end of the string. Note that using this convention, it is possible to have multiple files in a single folder (i.e. "/a/b/foo.jpg", "/a/b/bar.jpg").'}),"\n",(0,n.jsxs)(t.p,{children:["To support the two purposes, the GGC bucket contains two top-level folders: ",(0,n.jsx)(t.code,{children:"/images"})," and ",(0,n.jsx)(t.code,{children:"/backups"}),"."]}),"\n",(0,n.jsx)(t.h2,{id:"images",children:(0,n.jsx)(t.code,{children:"/images"})}),"\n",(0,n.jsxs)(t.p,{children:["A primary goal of the data model for the ",(0,n.jsx)(t.code,{children:"/images"})," folder is to create a one-to-one relationship between a documentID field that contains an image and the path to that image. In other words, given a documentID and the field of interest within that document, it is possible to deterministically construct the name of the file within the bucket.  Conversely, given the name of a file in our bucket, one can parse the string to determine the documentID and field of interest."]}),"\n",(0,n.jsxs)(t.admonition,{title:'The "downloadURL" cannot be deterministically constructed!',type:"warning",children:[(0,n.jsxs)(t.p,{children:['It is important to note that while the "file name" (i.e. ',(0,n.jsx)(t.code,{children:"images/chapters/chapter-US-002/chapter-US-002.pictureURL.jpg"}),') can be deterministically constructed, the corresponding "downloadURL" cannot be generated or "guessed". This is because Cloud Storage appends a "token" to the end of the URL to make it downloadable.']}),(0,n.jsx)(t.p,{children:"Note that even if you upload the exact same file to the exact same location in Cloud Storage, a different token will be generated (and the old one will no longer work.)"})]}),"\n",(0,n.jsx)(t.p,{children:'This one-to-one relationship simplifies management of Cloud Storage. For example, it makes it easier to perform "integrity checking" (i.e. making sure that all Cloud Storage files referenced in our Firebase collections exist, and that all Cloud Storage files are actually referenced by a document in a Firebase collection.)'}),"\n",(0,n.jsx)(t.p,{children:"The one-to-one relationship also simplifies management and inspection of Cloud Storage using the console by providing a consistent, easy to understand folder hierarchy."}),"\n",(0,n.jsxs)(t.p,{children:["There are currently eight collections that can have images associated with their documents: chapters, chat_rooms, chat_users, gardens, observations, share_posts, share_replies, and users. That said, ChatRoom and ChatUser documents do not have their own independent image; if they have an image, it is the image associated with the corresponding Garden or Chapter (in the case of ChatRoom) or the corresponding User (in the case of ChatUser). So, the ",(0,n.jsx)(t.code,{children:"/images"})," folder contains exactly six subfolders corresponding to the non-Chat collections. For example: ",(0,n.jsx)(t.code,{children:"/images/chapters"}),", ",(0,n.jsx)(t.code,{children:"/images/gardens"}),", etc."]}),"\n",(0,n.jsxs)(t.p,{children:["Inside each of these collection folders are another set of folders that are named with the documentID in the associated collection that contains an image. So, for example, there might be a folder named ",(0,n.jsx)(t.code,{children:"images/gardens/garden-US-98225-101-0404/"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["Inside the documentID folder are one or more .jpg files representing the images associated with this document in one or more of its fields.  They are named according to the following convention: ",(0,n.jsx)(t.code,{children:"<documentID>.<fieldName>.jpg"}),". For example,  ",(0,n.jsx)(t.code,{children:"garden-US-98225-101-0404.pictureURL.jpg"})," and ",(0,n.jsx)(t.code,{children:"garden-US-98225-101-0404.plotPlanURL.jpg"}),"."]}),"\n",(0,n.jsx)(t.admonition,{type:"info",children:(0,n.jsxs)(t.p,{children:["While we currently only allow a single image file per field, it is very likely that this restriction will be relaxed in the future to allow multiple images for a single field. We can revise this data model to support this by allowing an (optional) number in the file name, such as ",(0,n.jsx)(t.code,{children:"garden-US-98225-101-0404.plotPlanURL.1.jpg"}),"."]})}),"\n",(0,n.jsx)(t.p,{children:"Now that you've seen an example, here's a specification that covers all image file names:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"/images/<collection-name>/<documentID>/<documentID>.<field-name>.jpg\n"})}),"\n",(0,n.jsx)(t.p,{children:'So, given a documentID like "garden-US-98225-101-0404", and a field name like "plotPlanURL", we have everything we need to construct the complete file path to the associated image file.'}),"\n",(0,n.jsx)(t.p,{children:'Note that we can determine the collection name by extracting the initial prefix from the documentID (i.e. "garden") and mapping that to its associated collection name (i.e. "gardens").'}),"\n",(0,n.jsx)(t.p,{children:"Conversely, given the file path to an image, we can parse the string to determine the associated collection, documentID and field name."}),"\n",(0,n.jsxs)(t.admonition,{title:"Why is our Cloud Storage bucket still so disorganized?",type:"warning",children:[(0,n.jsx)(t.p,{children:'This data model specification was developed in June 2025, after almost two years of image file uploads. Previously, there was no "design", we just uploaded files and assigned them names according to different conventions at different times.'}),(0,n.jsx)(t.p,{children:"Now we are in a situation where there are users running releases of our app that do not implement this data model's name design, so the process of implementing this data model is an incremental one:"}),(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"First, we will implement a Migrate command that checks all the documents containing image URLs. If the image URL does not conform to our naming conventions, then the command will download the file and re-upload it to the new location that conforms to our naming conventions. Then the document's field will be updated to point to the new location. We can run this Migrate command periodically until there are no users running old releases of the app and thus no new documents being created wih image URLs that do not conform to these conventions."}),"\n",(0,n.jsx)(t.li,{children:"The Migrate command can result in duplicates of files: one file whose location conforms to our naming conventions and a second file with the same contents that does not. To address this, we will implement a Cloud Storage Garbage Collection command. This command finds all Cloud Storage files that are: (a) not in the backups/ directory, and (b) not referenced in their corresponding Firebase document. If both (a) and (b) are satisfied, they are deleted."}),"\n"]}),(0,n.jsx)(t.p,{children:"Eventually, neither the Migrate command nor the Cloud Storage Garbage Collection command should result in changes to the system."})]}),"\n",(0,n.jsx)(t.h2,{id:"backups",children:(0,n.jsx)(t.code,{children:"/backups"})}),"\n",(0,n.jsxs)(t.p,{children:["A new folder within the ",(0,n.jsx)(t.code,{children:"/backups"})," folder is created each time the run_backup.sh script is executed. This subfolder is named ",(0,n.jsx)(t.code,{children:"firebase_binary_backup_<timestamp>/"}),", where ",(0,n.jsx)(t.code,{children:"<timestamp>"}),' looks like "2025-06-10_13.03.38".  Inside this folder are a number of subfolders and files containing a binary backup of the GGC Firebase collections.']}),"\n",(0,n.jsx)(t.p,{children:"Once a recent subfolder is created, then the entire Google Cloud Storage bucket can be downloaded for off-site storage."}),"\n",(0,n.jsxs)(t.p,{children:["See ",(0,n.jsx)(t.a,{href:"/docs/develop/backups",children:"Backups"})," for more details."]})]})}function h(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(c,{...e})}):c(e)}},8453:(e,t,o)=>{o.d(t,{R:()=>s,x:()=>d});var n=o(6540);const a={},i=n.createContext(a);function s(e){const t=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function d(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),n.createElement(i.Provider,{value:t},e.children)}}}]);