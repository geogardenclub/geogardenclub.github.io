<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-develop/release-1.0/design-components/data-mutation" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.3.2">
<title data-rh="true">Data Mutation | Geo Garden Club</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://geogardenclub.github.io/img/logos/png/wordmark.png"><meta data-rh="true" name="twitter:image" content="https://geogardenclub.github.io/img/logos/png/wordmark.png"><meta data-rh="true" property="og:url" content="https://geogardenclub.github.io/docs/develop/release-1.0/design-components/data-mutation"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Data Mutation | Geo Garden Club"><meta data-rh="true" name="description" content="Prelude: AsyncValue"><meta data-rh="true" property="og:description" content="Prelude: AsyncValue"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://geogardenclub.github.io/docs/develop/release-1.0/design-components/data-mutation"><link data-rh="true" rel="alternate" href="https://geogardenclub.github.io/docs/develop/release-1.0/design-components/data-mutation" hreflang="en"><link data-rh="true" rel="alternate" href="https://geogardenclub.github.io/docs/develop/release-1.0/design-components/data-mutation" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Geo Garden Club RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Geo Garden Club Atom Feed"><link rel="stylesheet" href="/assets/css/styles.99b23296.css">
<script src="/assets/js/runtime~main.bf2264f6.js" defer="defer"></script>
<script src="/assets/js/main.8f859c04.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_gu5v" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logos/png/icon2.png" alt="Geo Garden Club" class="themedComponent_ZRzL themedComponent--light_dGsa"><img src="/img/logos/png/icon2.png" alt="Geo Garden Club" class="themedComponent_ZRzL themedComponent--dark_pzCA"></div><b class="navbar__title text--truncate">Geo Garden Club</b></a><a class="navbar__item navbar__link" href="/docs/home/welcome">About</a><a class="navbar__item navbar__link" href="/docs/user-guide/overview">User Guide</a></div><div class="navbar__items navbar__items--right"><div class="toggle_kWbt colorModeToggle_GwZs"><button class="clean-btn toggleButton_fOL9 toggleButtonDisabled_STpu" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_DCeJ"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_DFgp"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_IP3a"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_IbdI"><div class="docsWrapper_JGIH"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_SdI4" type="button"></button><div class="docRoot_eRbX"><aside class="theme-doc-sidebar-container docSidebarContainer_Ta75"><div class="sidebarViewport_fgog"><div class="sidebar_oDHW"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_vPEQ"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/develop">Welcome</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/develop/roadmap">Roadmap</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/develop/milestones">Milestones</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/develop/onboarding">Onboarding</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/develop/mockup/design">Mockup</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/develop/release-1.0/goals">Release 1.0 (Beta)</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/develop/release-1.0/goals">Goals</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/develop/release-1.0/installation">Installation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/develop/release-1.0/scripts">Scripts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/develop/release-1.0/cvp">Core Value Propositions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/develop/release-1.0/deployment">Deployment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/develop/release-1.0/testing">Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/develop/release-1.0/backups">Backups</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/develop/release-1.0/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/develop/release-1.0/coding-standards">Coding Standards</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/develop/release-1.0/beta-test-feedback">Release 1.0 (Beta) Feedback</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/develop/release-1.0/design-components/data-model">Design Components</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/develop/release-1.0/design-components/data-model">Data Model</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/develop/release-1.0/design-components/badges">Badges</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/develop/release-1.0/design-components/input-fields">GGC Input Fields</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/develop/release-1.0/design-components/with-widgets">&quot;With&quot; widgets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/develop/release-1.0/design-components/data-mutation">Data Mutation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/develop/release-1.0/design-components/test-design">Test Design</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/develop/release-2.0/chapterzipmap">Release 2.0 (Public)</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_lg0V"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_nDJs"><div class="docItemContainer_OGiL"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_k3Z9" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_JACu"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Release 1.0 (Beta)</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Design Components</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Data Mutation</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_QCOD theme-doc-toc-mobile tocMobile_N0YI"><button type="button" class="clean-btn tocCollapsibleButton_pHwF">On this page</button></div><div class="theme-doc-markdown markdown"><h1 id="data-mutation">Data Mutation</h1>
<h2 id="prelude-asyncvalue">Prelude: AsyncValue</h2>
<p>When your code interacts with the database (or some other external service), you are generally in one of two situations:</p>
<ol>
<li>Reading data: In this case, use a <code>with</code> widget to retrieve the appropriate data for display, and separate the asynchronous code (to retrieve data from the database) from the synchronous code (to display it in the UI.)</li>
<li>Writing data: In this case you must write asynchronous code to update the contents of the database.</li>
</ol>
<p>The Flutterverse is filled with articles and example code on how to accomplish (2). For GGC, we will use the &quot;Riverpod&quot; design pattern, which involves:</p>
<ol>
<li>Define a Riverpod provider (using the <code>@riverpod</code> annotation) to perform the manipulation.</li>
<li>Handle the resulting AsyncValue&#x27;s three possible states: loading, error, data.</li>
</ol>
<p>Here are some useful readings to get you started:</p>
<ul>
<li><a href="https://courses.ics.hawaii.edu/mobile-application-development/morea/state/reading-eli5-riverpod.html">Explain like I&#x27;m 5: Riverpod</a></li>
<li><a href="https://codewithandrea.com/articles/flutter-riverpod-generator/">How to autogenerate your providers with Flutter Riverpod Generator</a></li>
<li><a href="https://codewithandrea.com/articles/data-mutations-riverpod/">How to fetch data and perform data mutations with the Riverpod architecture</a></li>
</ul>
<p>Now let&#x27;s look at how we implement data mutation in GGC</p>
<h2 id="data-mutation-in-ggc">Data mutation in GGC</h2>
<p>In GGC, &quot;data mutation&quot; refers to creating, updating, and deleting entities from the database. In some cases, mutating one entity (i.e. deleting a Garden) requires the implicit mutation of many other entities (i.e. deleting the Garden&#x27;s associated Beds, Plantings, Observations, Outcomes, and Tasks).</p>
<p>Accomplishing a data mutation involves a complex interaction between the front-end user interface and the back-end database. There are many potential ways to accomplish this interaction, but we will follow a design pattern documented by Andrea Bizzotti in his various <a href="https://codewithandrea.com/">Code With Andrea</a> tutorials, with some additional customizations to suit our own GGC architecture.</p>
<p>The <a href="https://github.com/geogardenclub/ggc_app/blob/main/lib/features/garden/presentation/create_garden_screen.dart">CreateGardenScreen</a> and  <a href="https://github.com/geogardenclub/ggc_app/blob/main/lib/features/garden/presentation/mutate_garden_controller.dart">MutateGardenController</a> classes illustrate our data mutation design pattern.</p>
<p>Here is a walkthrough of some of the Garden code to illustrate the basic ideas of this design pattern.</p>
<h3 id="1-the-data-mutation-widget">1. The data mutation widget</h3>
<p>A &quot;Data mutation widget&quot; (for example, UpdateGardenScreen) presents a user interface for performing a data mutation. The actual UI component displayed at any moment in time by the widget is determined by an associated controller (for example, MutateGardenController).  The controller indicates which of four UI components to present: (1) an initial UI component (typically a form), (2) a loading indicator UI component (while waiting for an asynchronous action to complete, (3) a &quot;success&quot; component (displayed if the asynchronous action completes successfully) or (4) an error UI component (displayed if the asynchronous completes with an error).</p>
<p>Here&#x27;s an excerpt of UpdateGardenScreen illustrating the basic way in which the controller controls the UI state of the screen:</p>
<pre><code class="language-dart" metastring="title=&quot;lib/features/garden/presentation/update_garden_screen.dart&quot;">  AsyncValue asyncUpdate = ref.watch(mutateGardenControllerProvider);
  return Scaffold(
    appBar: AppBar(
      title: const Text(&#x27;Update Garden&#x27;),
      actions: [HelpButton(routeName: AppRoute.updateGarden.name)],
    ),
    body: asyncUpdate.when(
        data: (_) =&gt; updateGardenForm(),
        loading: () =&gt; const GgcLoadingIndicator(),
        error: (e, st) =&gt; GgcError(e.toString(), st.toString())));
}
</code></pre>
<h3 id="2-the-onsubmit-method">2. The onSubmit() method</h3>
<p>If the initial UI component is a form, then it should have an async onSubmit() callback method. This method typically involves a sequence of three phases. The first phase checks that the form field values pass any validation criteria. If so, the second phase creates domain model entities as indicated by the form values. The third phase calls the appropriate mutate controller method, passing it the domain entities and an onSuccess() callback, which tells the controller which page to go to if the data mutation is successful.</p>
<p>Here&#x27;s an example:</p>
<pre><code class="language-dart" metastring="title=&quot;lib/features/garden/presentation/edit_garden_screen.dart&quot;">   onSubmit() async {
      // 1. Check that form fields are valid.
      bool isValid = _formKey.currentState?.saveAndValidate() ?? false;
      if (!isValid) return;
      // 2. Create domain objects to send to controller.
      String name = FieldKey.gardenTextField.currentState?.value;
      List&lt;dynamic&gt; xFiles =
          FieldKey.singleImagePicker.currentState?.value ?? [];
      String editorsString =
          FieldKey.editorsTextField.currentState?.value ?? &#x27;&#x27;;
      Garden garden = gardens.getGarden(gardenID);
      List&lt;String&gt; updatedEditorUserIDs = users.parseUsernames(editorsString);
      List&lt;Editor&gt; editorsToAdd = gardens.editors.makeNewEditors(
          gardenID: gardenID,
          chapterID: garden.chapterID,
          gardenerIDs: updatedEditorUserIDs);
      List&lt;Editor&gt; editorsToDelete = gardens.editors.getEditors(gardenID);
      // Only update Editors collection if the field has changed.
      if (gardens.editors.sameEditorList(editorsToAdd, editorsToDelete)) {
        editorsToAdd = [];
        editorsToDelete = [];
      }
      String profilePictureUrl = (xFiles.isNotEmpty &amp;&amp; xFiles[0] is XFile)
          ? await ImageStorage.cropAndUploadImage(
              xFile: xFiles[0], entityID: gardenID, context: context)
          : garden.profilePicture;
      Garden updatedGarden = Garden(
          gardenID: gardenID,
          name: name,
          profilePicture: profilePictureUrl,
          chapterID: chapters.currentChapterID,
          cropIDs: garden.cropIDs,
          sharedSeedIDs: garden.sharedSeedIDs,
          lastUpdate: DateTime.now(),
          ownerID: users.currentUserID,
          pictures: []);
      // 3. Use controller to invoke updates on database.
      ref.read(mutateGardenControllerProvider.notifier).updateGarden(
            garden: updatedGarden,
            editorsToAdd: editorsToAdd,
            editorsToDelete: editorsToDelete,
            onSuccess: () {
              context.pop();
              GlobalSnackBar.show(&#x27;Garden &quot;$name&quot; updated.&#x27;);
            },
          );
    }
</code></pre>
<admonition title="Don&#x27;t pass Collection classes to the controller method" type="important"><p>To maintain separation of concerns, the values passed to mutate controller methods should be individual domain entities (i.e. <code>Garden</code>, <code>Editor</code>), lists of domain entities (i.e. <code>List&lt;Garden&gt;</code>, <code>List&lt;Editor&gt;</code>), or primitive types (<code>String</code>, <code>int</code>, etc).  Don&#x27;t pass collections (i.e. <code>GardenCollection</code>, <code>EditorCollection</code>).  Use these collection classes within the onSubmit() method to determine the domain entities to pass.</p></admonition>
<h3 id="3-mutate-controller-create-update-delete-methods">3. Mutate controller create, update, delete methods</h3>
<p>The Mutate Controller class typically implements create, update, and delete methods to handle the associated mutation.  These methods will often need to make multiple asynchronous calls to the backend database.  To do this efficiently, and also to provide atomicity, the controller should use the <a href="https://firebase.google.com/docs/firestore/manage-data/transactions#batched-writes">Firestore batched write</a> facility.</p>
<p>Here is an example from MutateGardenController for creating a new Garden. Note that both the Garden and Editor databases are mutated:</p>
<pre><code class="language-dart" metastring="title=&quot;lib/features/garden/presentation/mutate_garden_controller.dart&quot;"> Future&lt;void&gt; createGarden({
    required Garden garden,
    required List&lt;Editor&gt; editors,
    required VoidCallback onSuccess,
  }) async {
    state = const AsyncLoading();
    AsyncValue nextState = const AsyncLoading();
    GardenDatabase gardenDatabase = ref.watch(gardenDatabaseProvider);
    EditorDatabase editorDatabase = ref.watch(editorDatabaseProvider);
    final WriteBatch batch = FirebaseFirestore.instance.batch();
    gardenDatabase.setGardenBatch(batch, garden);
    editorDatabase.addEditorsBatch(batch, editors);
    await batch
        .commit()
        .then((_) =&gt; nextState = const AsyncValue.data(null))
        .catchError((e, st) =&gt; nextState = AsyncValue.error(e, st));
    if (mounted) {
      state = nextState;
    }
    if (!state.hasError) {
      onSuccess();
    }
  }
</code></pre>
<p>Following the CodeWithAndrea guidelines, this method first sets the controller state to <code>AsyncLoading</code>.  Then it gets the databases of interest, creates a <code>batch</code> variable, and adds mutations to that batch variable by passing it into the appropriate methods in the variable database classes. Finally, it invokes the <code>batch.commit()</code> method to do all of the mutations at once, and either sets the state to <code>AsyncData()</code> if everything went well or <code>AsyncError()</code> if a problem occurred. A nice feature of batched writes is that they are performed as a transaction---either all of the writes succeed, or none of them do.</p>
<h3 id="4-database-methods">4. Database methods</h3>
<p>The final part of this coding standard involves the appropriate definition of database methods. As shown above, database methods should be written to accept a <code>batch</code> parameter, and result in that parameter being updated with additional operations to perform. Here is an example:</p>
<pre><code class="language-dart" metastring="title=&quot;lib/features/garden/data/editor_database.dart"> void createEditorsBatch(WriteBatch batch, List&lt;Editor&gt; editors) {
    for (Editor editor in editors) {
      _service.setDataBatch(
          batch: batch,
          path: FirestorePath.editor(editor.editorID),
          data: editor.toJson());
    }
  }
</code></pre>
<h3 id="a-template-for-the-controller-class">A template for the controller class</h3>
<p>There is some boilerplate code for controllers.  To make it a little easier to create new controllers, here is a template.  See the TODO comments for places where code needs to be added, and replace all occurrences of &quot;TEMPLATE&quot; by the entity being controller (i.e. Garden, User, Task, etc).</p>
<p>Note that we&#x27;ll use &quot;create&quot; rather than &quot;add&quot; to conform to the CRUD acronym. This means that the associated screens should be changed from &quot;AddX&quot; to &quot;CreateX&quot;.</p>
<pre><code class="language-dart">import &#x27;package:cloud_firestore/cloud_firestore.dart&#x27;;
import &#x27;package:flutter/foundation.dart&#x27;;
import &#x27;package:riverpod_annotation/riverpod_annotation.dart&#x27;;

part &#x27;mutate_TEMPLATE_controller.g.dart&#x27;;

@riverpod
class MutateTEMPLATEController extends _$MutateTEMPLATEController {
  bool mounted = true;

  @override
  FutureOr&lt;void&gt; build() {
    ref.onDispose(() =&gt; mounted = false);
    state = const AsyncData(null);
  }

  Future&lt;void&gt; createTEMPLATE({
    /// TODO: Pass in domain object here.
    required VoidCallback onSuccess,
  }) async {
    state = const AsyncLoading();
    AsyncValue nextState = const AsyncLoading();
    // TODO: Watch the appropriate database instances here.
    final WriteBatch batch = FirebaseFirestore.instance.batch();
    // TODO: Invoke the database batch methods here.
    await batch
        .commit()
        .then((_) =&gt; nextState = const AsyncValue.data(null))
        .catchError((e, st) =&gt; nextState = AsyncValue.error(e, st));
    if (mounted) {
      state = nextState;
    }
    if (!state.hasError) {
      onSuccess();
    }
  }


  Future&lt;void&gt; updateTEMPLATE({
    /// TODO: Pass in domain data here
    required VoidCallback onSuccess,
  }) async {
    state = const AsyncLoading();
    AsyncValue nextState = const AsyncLoading();
    /// TODO: ref.watch the appropriate databases here.
    final WriteBatch batch = FirebaseFirestore.instance.batch();
    /// TODO: Invoke the appropriate database batch methods here.
    await batch
        .commit()
        .then((_) =&gt; nextState = const AsyncValue.data(null))
        .catchError((e, st) =&gt; nextState = AsyncValue.error(e, st));
    if (mounted) {
      state = nextState;
    }
    if (!state.hasError) {
      onSuccess();
    }
  }
  
  Future&lt;void&gt; deleteTEMPLATE({
    /// TODO: Pass in the appropriate domain objects here
    required VoidCallback onSuccess,
  }) async {
    state = const AsyncLoading();
    AsyncValue nextState = const AsyncLoading();
    /// TODO: Watch the appropriate databases here.
    final WriteBatch batch = FirebaseFirestore.instance.batch();
    /// TODO: Invoke the appropriate database batch methods here.
    await batch
        .commit()
        .then((_) =&gt; nextState = const AsyncValue.data(null))
        .catchError((e, st) =&gt; nextState = AsyncValue.error(e, st));
    if (mounted) {
      state = nextState;
    }
    if (!state.hasError) {
      onSuccess();
    }
  }
}
</code></pre></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/develop/release-1.0/design-components/with-widgets"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">&quot;With&quot; widgets</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/develop/release-1.0/design-components/test-design"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Test Design</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_IS5x thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#prelude-asyncvalue" class="table-of-contents__link toc-highlight">Prelude: AsyncValue</a></li><li><a href="#data-mutation-in-ggc" class="table-of-contents__link toc-highlight">Data mutation in GGC</a><ul><li><a href="#1-the-data-mutation-widget" class="table-of-contents__link toc-highlight">1. The data mutation widget</a></li><li><a href="#2-the-onsubmit-method" class="table-of-contents__link toc-highlight">2. The onSubmit() method</a></li><li><a href="#3-mutate-controller-create-update-delete-methods" class="table-of-contents__link toc-highlight">3. Mutate controller create, update, delete methods</a></li><li><a href="#4-database-methods" class="table-of-contents__link toc-highlight">4. Database methods</a></li><li><a href="#a-template-for-the-controller-class" class="table-of-contents__link toc-highlight">A template for the controller class</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__links text--center"><div class="footer__links"><a href="https://www.facebook.com/geogardenclub" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a href="https://www.instagram.com/geogardenclub/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Instagram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a href="https://geogardenclub.us10.list-manage.com/subscribe?u=2c9db5ab59b4602f6c71e2091&amp;id=c75bee0e1e" target="_blank" rel="noopener noreferrer" class="footer__link-item">Join the GGC mailing list<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a href="https://us10.campaign-archive.com/home/?u=2c9db5ab59b4602f6c71e2091&amp;id=c75bee0e1e" target="_blank" rel="noopener noreferrer" class="footer__link-item">News Archive<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Geo Garden Club, LLC</div></div></div></footer></div>
</body>
</html>